{
  "id": "snapshot_1765718412775_aeeol73jz",
  "approvalId": "approval_1765718412771_504hov75m",
  "approvalTitle": "Design: Public Display, Analytics & Production (Phase 3)",
  "version": 1,
  "timestamp": "2025-12-14T13:20:12.775Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nPhase 3 (Public Analytics) introduces public article viewing with comprehensive disclaimer systems, privacy-compliant analytics tracking, visualization dashboards, and production hardening features. This design leverages existing infrastructure (Prisma models, Express routing, React components) and extends them with new services, controllers, middleware, and UI components.\n\nThe design follows the existing modular architecture: controllers handle HTTP requests with Zod validation, services contain business logic, utilities are single-purpose, and React pages compose reusable components.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\nThis implementation follows the existing technical patterns:\n- **TypeScript**: Strict typing throughout with defined interfaces\n- **Validation**: Zod schemas for all API inputs\n- **Database**: Prisma ORM with existing PageView model\n- **Frontend**: React 18+ with functional components, hooks, and context\n- **Styling**: Tailwind CSS utility classes\n- **i18n**: react-i18next for translations (EN/ES)\n- **Error Handling**: Centralized error handler middleware\n- **Testing**: Jest + React Testing Library + Playwright\n\n### Project Structure (structure.md)\n\nFollowing the established structure:\n- `src/server/controllers/`: New analyticsController.ts, publicController.ts\n- `src/server/services/`: New analyticsService.ts, geoipService.ts\n- `src/server/utils/`: New ipAnonymizer.ts, userAgentParser.ts\n- `src/server/middleware/`: New rateLimiter.ts, analytics.ts\n- `src/client/pages/`: New Analytics.tsx, PublicArticle.tsx\n- `src/client/components/`: New Analytics/, PublicArticle/, DisclaimerBanner/\n- `src/client/locales/`: Extended translations for analytics\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n- **ArticleController**: Extend with public article retrieval method\n- **ErrorHandler Middleware**: Use for consistent error responses\n- **Auth Middleware**: Protect analytics routes\n- **Database Config**: Reuse `db` instance for PageView queries\n- **i18n Setup**: Extend with analytics translations\n- **AuthContext**: Check user roles for analytics access\n- **Tailwind Config**: Use existing color palette and responsive utilities\n\n### Integration Points\n\n- **PageView Model**: Already exists in Prisma schema (lines 101-113 in schema.prisma)\n- **Article Model**: Has `pageViews` relation defined\n- **User Model**: Language preference for i18n\n- **API Routes**: Add new `/api/analytics/*` and `/api/track/*` endpoints\n- **Public Routes**: Add `/:brandSlug/article/:year/:month/:slug` pattern\n- **Frontend Routing**: Integrate Analytics page into dashboard navigation\n\n## Architecture\n\nThe architecture follows a three-layer pattern:\n\n1. **Presentation Layer** (React Components)\n   - Public article view with disclaimers\n   - Analytics dashboard with charts\n   - CSV export functionality\n\n2. **Application Layer** (Controllers & Middleware)\n   - Request validation with Zod\n   - Rate limiting\n   - Analytics tracking middleware\n   - Response formatting\n\n3. **Business Logic Layer** (Services & Utilities)\n   - Analytics aggregation\n   - GeoIP lookup\n   - IP anonymization\n   - User agent parsing\n\n### Modular Design Principles\n\n- **Single File Responsibility**: Each service handles one domain (analytics, geoip, ip anonymization)\n- **Component Isolation**: Disclaimer components, chart components, and analytics filters are separate\n- **Service Layer Separation**: Analytics data access separated from aggregation logic\n- **Utility Modularity**: IP hashing, UA parsing, GeoIP are independent utilities\n\n```mermaid\ngraph TD\n    A[Public User] -->|GET /brand/article/2024/12/slug| B[PublicController]\n    B --> C[ArticleService]\n    C --> D[Database]\n    B --> E[Analytics Middleware]\n    E --> F[IP Anonymizer]\n    E --> G[GeoIP Service]\n    E --> H[UA Parser]\n    E --> I[PageView Record]\n\n    J[Authenticated User] -->|GET /api/analytics| K[AnalyticsController]\n    K --> L[Auth Middleware]\n    K --> M[Rate Limiter]\n    K --> N[AnalyticsService]\n    N --> D\n    N --> O[Recharts Visualization]\n\n    P[Admin] -->|GET /api/analytics/export| K\n    K --> Q[CSV Stream]\n```\n\n## Components and Interfaces\n\n### Backend Components\n\n#### 1. PublicController\n- **Purpose:** Handle public article viewing requests\n- **File:** `src/server/controllers/publicController.ts`\n- **Interfaces:**\n  - `viewArticle(req, res)`: Get published article by brand slug and article slug\n- **Dependencies:**\n  - Database (Prisma)\n  - Analytics middleware\n- **Reuses:** Error handler middleware\n\n#### 2. AnalyticsController\n- **Purpose:** Handle analytics data requests and exports\n- **File:** `src/server/controllers/analyticsController.ts`\n- **Interfaces:**\n  - `getOverview(req, res)`: Global analytics stats\n  - `getBrandAnalytics(req, res)`: Brand-specific stats\n  - `getArticleAnalytics(req, res)`: Article-specific stats\n  - `exportAnalytics(req, res)`: Export CSV\n- **Dependencies:**\n  - AnalyticsService\n  - Auth middleware (super admin only)\n  - Rate limiter\n- **Reuses:** Error handler, auth middleware pattern\n\n#### 3. AnalyticsService\n- **Purpose:** Business logic for analytics aggregation\n- **File:** `src/server/services/analyticsService.ts`\n- **Interfaces:**\n  - `getGlobalStats()`: Total views, articles, brands\n  - `getViewsOverTime(filters)`: Time series data\n  - `getDeviceBreakdown(filters)`: Device type distribution\n  - `getGeographicDistribution(filters)`: Country-based stats\n  - `getTopArticles(filters)`: Most viewed articles\n  - `streamAnalyticsCSV(filters)`: Stream CSV data\n- **Dependencies:** Database (Prisma)\n- **Reuses:** Existing Prisma patterns from BrandService\n\n#### 4. GeoIP Service\n- **Purpose:** IP address to geographic location lookup\n- **File:** `src/server/services/geoipService.ts`\n- **Interfaces:**\n  - `lookup(ip: string): Promise<{ country, city } | null>`\n- **Dependencies:** geoip-lite or similar library\n- **Reuses:** None (new utility)\n\n#### 5. IP Anonymizer Utility\n- **Purpose:** Hash IP addresses for GDPR compliance\n- **File:** `src/server/utils/ipAnonymizer.ts`\n- **Interfaces:**\n  - `anonymizeIP(ip: string): string`: SHA-256 hash\n- **Dependencies:** Node crypto module\n- **Reuses:** None (new utility)\n\n#### 6. User Agent Parser Utility\n- **Purpose:** Extract browser, OS, device from user agent string\n- **File:** `src/server/utils/userAgentParser.ts`\n- **Interfaces:**\n  - `parseUserAgent(ua: string): { browser, os, device }`\n- **Dependencies:** ua-parser-js or similar\n- **Reuses:** None (new utility)\n\n#### 7. Rate Limiter Middleware\n- **Purpose:** Prevent API abuse\n- **File:** `src/server/middleware/rateLimiter.ts`\n- **Interfaces:**\n  - `apiRateLimiter`: 100 req/15min per IP\n  - `aiGenerationRateLimiter`: 5 req/hour per user\n- **Dependencies:** express-rate-limit\n- **Reuses:** Auth middleware pattern\n\n#### 8. Analytics Tracking Middleware\n- **Purpose:** Track page views on public articles\n- **File:** `src/server/middleware/analytics.ts`\n- **Interfaces:**\n  - `trackPageView(req, res, next)`: Record view after response\n- **Dependencies:**\n  - IP Anonymizer\n  - GeoIP Service\n  - UA Parser\n  - Database\n- **Reuses:** Middleware pattern from auth.ts\n\n### Frontend Components\n\n#### 9. PublicArticle Page\n- **Purpose:** Display article with disclaimers to public\n- **File:** `src/client/pages/PublicArticle.tsx`\n- **Interfaces:**\n  - Route params: `/:brandSlug/article/:year/:month/:slug`\n- **Dependencies:**\n  - DisclaimerBanner component\n  - DisclaimerFooter component\n  - Watermark component\n  - API service\n- **Reuses:** Tailwind styling patterns from Dashboard\n\n#### 10. Analytics Page\n- **Purpose:** Dashboard for viewing analytics data\n- **File:** `src/client/pages/Analytics.tsx`\n- **Interfaces:**\n  - Filter controls (date range, brand, article)\n  - Chart visualizations\n  - Export button\n- **Dependencies:**\n  - AnalyticsCharts component\n  - AnalyticsFilters component\n  - TopArticlesTable component\n  - API service\n  - AuthContext (role check)\n- **Reuses:** Dashboard layout patterns, useAuth hook\n\n#### 11. DisclaimerBanner Component\n- **Purpose:** Sticky top banner with warning\n- **File:** `src/client/components/PublicArticle/DisclaimerBanner.tsx`\n- **Interfaces:**\n  - Props: `language: 'en' | 'es'`\n- **Dependencies:** react-i18next\n- **Reuses:** Tailwind utility classes\n\n#### 12. Watermark Component\n- **Purpose:** Semi-transparent \"FICTIONAL\" overlay\n- **File:** `src/client/components/PublicArticle/Watermark.tsx`\n- **Interfaces:**\n  - Props: `text: string`\n- **Dependencies:** None\n- **Reuses:** Tailwind positioning classes\n\n#### 13. AnalyticsCharts Component\n- **Purpose:** Render Recharts visualizations\n- **File:** `src/client/components/Analytics/AnalyticsCharts.tsx`\n- **Interfaces:**\n  - Props: `data: AnalyticsData, loading: boolean`\n  - Renders: LineChart, PieChart, BarChart\n- **Dependencies:** recharts library\n- **Reuses:** Tailwind grid layout\n\n#### 14. AnalyticsFilters Component\n- **Purpose:** Date range, brand, article filters\n- **File:** `src/client/components/Analytics/AnalyticsFilters.tsx`\n- **Interfaces:**\n  - Props: `onFilterChange: (filters) => void`\n  - Emits: Filter state object\n- **Dependencies:** React state hooks\n- **Reuses:** Form input patterns from existing pages\n\n#### 15. Disclaimer Configuration Files\n- **Purpose:** Editable disclaimer content\n- **File:** `src/config/disclaimers.json` or `src/config/disclaimers/`\n- **Interfaces:**\n  - JSON structure with EN/ES translations\n  - Sections: banner, footer, meta description\n- **Dependencies:** None\n- **Reuses:** None (new config)\n\n## Data Models\n\n### PageView (Already exists in Prisma)\n```typescript\ninterface PageView {\n  id: string              // UUID\n  articleId: string       // Foreign key to Article\n  ipAddress: string       // SHA-256 hashed\n  country: string | null  // From GeoIP\n  city: string | null     // From GeoIP\n  browser: string | null  // From UA parsing\n  os: string | null       // From UA parsing\n  device: string | null   // desktop | mobile | tablet\n  referrer: string | null // HTTP Referer header\n  timestamp: Date         // Auto-generated\n}\n```\n\n### AnalyticsStats (Service Interface)\n```typescript\ninterface AnalyticsStats {\n  totalViews: number\n  totalArticles: number\n  totalBrands: number\n  viewsOverTime: Array<{ date: string; views: number }>\n  deviceBreakdown: Array<{ device: string; count: number; percentage: number }>\n  geographicDistribution: Array<{ country: string; count: number }>\n  topArticles: Array<{\n    id: string\n    title: string\n    brand: string\n    views: number\n    lastViewed: Date\n  }>\n}\n```\n\n### AnalyticsFilters (Request Interface)\n```typescript\ninterface AnalyticsFilters {\n  startDate?: Date\n  endDate?: Date\n  brandId?: string\n  articleId?: string\n  limit?: number    // For top articles\n  offset?: number   // For pagination\n}\n```\n\n### DisclaimerConfig (Configuration)\n```typescript\ninterface DisclaimerConfig {\n  banner: {\n    en: { icon: string; text: string }\n    es: { icon: string; text: string }\n  }\n  footer: {\n    en: { title: string; content: string }\n    es: { title: string; content: string }\n  }\n  watermark: {\n    text: string      // Same for all languages\n    opacity: number   // 0.03\n    rotation: number  // -45\n  }\n  metaTags: {\n    robots: string    // \"noindex, nofollow\"\n    ogPrefix: string  // \"[FICTIONAL] \"\n  }\n}\n```\n\n### GeoIPResult (Utility Interface)\n```typescript\ninterface GeoIPResult {\n  country: string | null\n  city: string | null\n}\n```\n\n### UserAgentInfo (Utility Interface)\n```typescript\ninterface UserAgentInfo {\n  browser: string | null     // \"Chrome 120.0\"\n  os: string | null          // \"Windows 10\"\n  device: 'desktop' | 'mobile' | 'tablet' | null\n}\n```\n\n## API Endpoints\n\n### Public Routes (No auth required)\n- `GET /:brandSlug/article/:year/:month/:slug` - View published article\n- `POST /api/track/:articleId` - Track page view (called by frontend)\n\n### Protected Routes (Auth required)\n- `GET /api/analytics/overview` - Global stats (super admin only)\n- `GET /api/analytics/brand/:id` - Brand stats\n- `GET /api/analytics/article/:id` - Article stats\n- `GET /api/analytics/export` - Export CSV (super admin only)\n\n### Rate Limiting\n- Public article viewing: No limit (read-only)\n- Analytics endpoints: 100 req/15min per IP\n- AI generation (existing): 5 req/hour per user\n\n## Error Handling\n\n### Error Scenarios\n\n1. **Article Not Found (404)**\n   - **Handling:** Return 404 with message \"Article not found\"\n   - **User Impact:** Public sees \"Article not found\" page\n\n2. **Article is Draft (404)**\n   - **Handling:** Return 404 to prevent leaking draft content\n   - **User Impact:** Public sees \"Article not found\" (same as above)\n\n3. **Unauthorized Analytics Access (401)**\n   - **Handling:** Return 401 if user not authenticated\n   - **User Impact:** Redirect to login\n\n4. **Forbidden Analytics Access (403)**\n   - **Handling:** Return 403 if user role insufficient\n   - **User Impact:** Show \"Permission denied\" message\n\n5. **GeoIP Service Failure**\n   - **Handling:** Log warning, set country/city to null, continue tracking\n   - **User Impact:** None (graceful degradation)\n\n6. **Rate Limit Exceeded (429)**\n   - **Handling:** Return 429 with retry-after header\n   - **User Impact:** Show \"Too many requests, please try again later\"\n\n7. **CSV Export Memory Error**\n   - **Handling:** Stream data in chunks, catch errors\n   - **User Impact:** Show \"Export failed, try with smaller date range\"\n\n8. **Invalid Filter Parameters (400)**\n   - **Handling:** Zod validation returns 400 with field errors\n   - **User Impact:** Show validation messages on filter form\n\n## Security Measures\n\n### Input Validation\n- All API endpoints use Zod schemas\n- Validate date ranges, UUIDs, enums\n- Sanitize user input to prevent XSS\n\n### Rate Limiting\n```typescript\n// API rate limiter (100 req/15min per IP)\nconst apiLimiter = rateLimit({\n  windowMs: 15 * 60 * 1000,\n  max: 100,\n  message: 'Too many requests, please try again later',\n});\n\n// AI generation limiter (5 req/hour per user)\nconst aiLimiter = rateLimit({\n  windowMs: 60 * 60 * 1000,\n  max: 5,\n  keyGenerator: (req) => req.user.userId,\n  message: 'AI generation limit exceeded',\n});\n```\n\n### Security Headers (helmet.js)\n```typescript\napp.use(helmet({\n  contentSecurityPolicy: {\n    directives: {\n      defaultSrc: [\"'self'\"],\n      scriptSrc: [\"'self'\", \"'unsafe-inline'\"],\n      styleSrc: [\"'self'\", \"'unsafe-inline'\"],\n      imgSrc: [\"'self'\", \"data:\", \"https:\"],\n    },\n  },\n  hsts: {\n    maxAge: 31536000,\n    includeSubDomains: true,\n  },\n}));\n```\n\n### IP Anonymization\n```typescript\n// Before storing IP in database\nconst anonymizedIP = crypto\n  .createHash('sha256')\n  .update(ipAddress)\n  .digest('hex');\n```\n\n### Meta Tags for Public Articles\n```html\n<meta name=\"robots\" content=\"noindex, nofollow\">\n<meta property=\"og:title\" content=\"[FICTIONAL] Article Title\">\n<meta property=\"og:description\" content=\"This is fictional content...\">\n```\n\n## Internationalization (i18n)\n\n### Translation Keys to Add\n\n**EN (src/client/locales/en/common.json):**\n```json\n{\n  \"analytics\": {\n    \"title\": \"Analytics\",\n    \"overview\": \"Overview\",\n    \"totalViews\": \"Total Views\",\n    \"totalArticles\": \"Total Articles\",\n    \"viewsOverTime\": \"Views Over Time\",\n    \"deviceBreakdown\": \"Device Breakdown\",\n    \"geographicDistribution\": \"Geographic Distribution\",\n    \"topArticles\": \"Top Articles\",\n    \"export\": \"Export CSV\",\n    \"filters\": {\n      \"dateRange\": \"Date Range\",\n      \"brand\": \"Brand\",\n      \"article\": \"Article\",\n      \"apply\": \"Apply Filters\"\n    }\n  },\n  \"disclaimer\": {\n    \"banner\": \"⚠️ FICTIONAL CONTENT - This article is entirely fictional\",\n    \"footer\": {\n      \"title\": \"Disclaimer\",\n      \"content\": \"This article is entirely fictional and created for entertainment purposes only. All names, characters, events, and locations are products of imagination. Any resemblance to actual persons, living or dead, or actual events is purely coincidental.\"\n    }\n  },\n  \"public\": {\n    \"notFound\": \"Article not found\",\n    \"readTime\": \"min read\",\n    \"relatedArticles\": \"Related Articles\"\n  }\n}\n```\n\n**ES (src/client/locales/es/common.json):**\n```json\n{\n  \"analytics\": {\n    \"title\": \"Analíticas\",\n    \"overview\": \"Resumen\",\n    \"totalViews\": \"Visitas Totales\",\n    \"totalArticles\": \"Artículos Totales\",\n    \"viewsOverTime\": \"Visitas a lo Largo del Tiempo\",\n    \"deviceBreakdown\": \"Distribución por Dispositivo\",\n    \"geographicDistribution\": \"Distribución Geográfica\",\n    \"topArticles\": \"Artículos Principales\",\n    \"export\": \"Exportar CSV\",\n    \"filters\": {\n      \"dateRange\": \"Rango de Fechas\",\n      \"brand\": \"Marca\",\n      \"article\": \"Artículo\",\n      \"apply\": \"Aplicar Filtros\"\n    }\n  },\n  \"disclaimer\": {\n    \"banner\": \"⚠️ CONTENIDO FICTICIO - Este artículo es completamente ficticio\",\n    \"footer\": {\n      \"title\": \"Descargo de Responsabilidad\",\n      \"content\": \"Este artículo es completamente ficticio y creado solo con fines de entretenimiento. Todos los nombres, personajes, eventos y ubicaciones son productos de la imaginación. Cualquier parecido con personas reales, vivas o muertas, o eventos reales es pura coincidencia.\"\n    }\n  },\n  \"public\": {\n    \"notFound\": \"Artículo no encontrado\",\n    \"readTime\": \"min de lectura\",\n    \"relatedArticles\": \"Artículos Relacionados\"\n  }\n}\n```\n\n## Production Hardening\n\n### 1. Database Backups\n```bash\n# Daily backup script (scripts/backup-db.sh)\n#!/bin/bash\nBACKUP_DIR=\"./backups\"\nTIMESTAMP=$(date +%Y%m%d_%H%M%S)\ncp ./data/fictional_news.db \"$BACKUP_DIR/fictional_news_$TIMESTAMP.db\"\n# Keep only last 7 days\nfind $BACKUP_DIR -name \"fictional_news_*.db\" -mtime +7 -delete\n```\n\n### 2. Logging (Winston)\n```typescript\nimport winston from 'winston';\n\nconst logger = winston.createLogger({\n  level: 'info',\n  format: winston.format.json(),\n  transports: [\n    new winston.transports.File({ filename: 'error.log', level: 'error' }),\n    new winston.transports.File({ filename: 'combined.log' }),\n  ],\n});\n\nif (process.env.NODE_ENV !== 'production') {\n  logger.add(new winston.transports.Console({\n    format: winston.format.simple(),\n  }));\n}\n```\n\n### 3. Health Check Endpoint\n```typescript\n// GET /health\napp.get('/health', async (req, res) => {\n  try {\n    // Check database connection\n    await db.$queryRaw`SELECT 1`;\n\n    const appVersion = await db.appVersion.findFirst({\n      orderBy: { appliedAt: 'desc' },\n    });\n\n    res.json({\n      status: 'healthy',\n      version: process.env.npm_package_version,\n      dbVersion: appVersion?.version,\n      timestamp: new Date().toISOString(),\n    });\n  } catch (error) {\n    res.status(503).json({\n      status: 'unhealthy',\n      error: 'Database connection failed',\n    });\n  }\n});\n```\n\n### 4. Graceful Shutdown\n```typescript\nprocess.on('SIGTERM', async () => {\n  console.log('SIGTERM received, shutting down gracefully');\n  server.close(() => {\n    console.log('HTTP server closed');\n    db.$disconnect();\n    process.exit(0);\n  });\n});\n```\n\n### 5. Docker Health Check\n```dockerfile\nHEALTHCHECK --interval=30s --timeout=10s --retries=3 \\\n  CMD curl -f http://localhost:3000/health || exit 1\n```\n\n## Performance Optimizations\n\n### 1. Analytics Query Optimization\n- Use Prisma's `groupBy` for aggregations\n- Add database indexes on `timestamp`, `articleId`, `country`\n- Limit date ranges to prevent full table scans\n- Use pagination for large result sets\n\n### 2. CSV Export Streaming\n```typescript\nasync streamAnalyticsCSV(res: Response, filters: AnalyticsFilters) {\n  res.setHeader('Content-Type', 'text/csv');\n  res.setHeader('Content-Disposition', 'attachment; filename=analytics.csv');\n\n  const stream = res;\n  stream.write('Timestamp,Article,Brand,Country,City,Browser,OS,Device\\n');\n\n  // Stream in batches of 1000\n  let skip = 0;\n  const take = 1000;\n\n  while (true) {\n    const batch = await db.pageView.findMany({\n      where: { /* filters */ },\n      take,\n      skip,\n      include: { article: { include: { brand: true } } },\n    });\n\n    if (batch.length === 0) break;\n\n    batch.forEach(view => {\n      stream.write(/* CSV row */);\n    });\n\n    skip += take;\n  }\n\n  stream.end();\n}\n```\n\n### 3. Frontend Optimizations\n- Lazy load Recharts components\n- Debounce filter changes (500ms)\n- Use React.memo for chart components\n- Cache analytics data with react-query or SWR\n- Compress large CSV downloads\n\n### 4. Database Indexes (Migration)\n```sql\n-- migrations/1.2.0/001_add_analytics_indexes.sql\nCREATE INDEX idx_pageview_timestamp ON PageView(timestamp);\nCREATE INDEX idx_pageview_articleid ON PageView(articleId);\nCREATE INDEX idx_pageview_country ON PageView(country);\nCREATE INDEX idx_article_status ON Article(status);\nCREATE INDEX idx_article_publishedat ON Article(publishedAt);\n```\n\n## Testing Strategy\n\n### Unit Testing\n\n**Services:**\n- `analyticsService.test.ts`: Test aggregation logic with mock data\n- `geoipService.test.ts`: Test IP lookup with known IPs\n- `ipAnonymizer.test.ts`: Test SHA-256 hashing consistency\n- `userAgentParser.test.ts`: Test parsing various UA strings\n\n**Utilities:**\n- Test edge cases (null, undefined, malformed input)\n- Test GDPR compliance (IP not stored raw)\n\n**Components:**\n- `DisclaimerBanner.test.tsx`: Test rendering with EN/ES\n- `AnalyticsCharts.test.tsx`: Test chart rendering with mock data\n- `AnalyticsFilters.test.tsx`: Test filter state changes\n\n### Integration Testing\n\n**API Endpoints:**\n- `GET /api/analytics/overview`: Test with auth, without auth, with filters\n- `GET /api/analytics/export`: Test CSV generation, streaming\n- `GET /:brandSlug/article/:year/:month/:slug`: Test published vs draft\n- `POST /api/track/:articleId`: Test page view recording\n\n**Middleware:**\n- `rateLimiter.test.ts`: Test rate limit enforcement\n- `analytics.test.ts`: Test tracking middleware flow\n\n### End-to-End Testing\n\n**Playwright Scenarios:**\n\n1. **Public Article Viewing**\n   - Navigate to public article URL\n   - Verify disclaimer banner visible\n   - Verify watermark overlay present\n   - Verify footer disclaimer\n   - Verify meta tags in HTML head\n   - Verify page view recorded in database\n\n2. **Analytics Dashboard**\n   - Login as super admin\n   - Navigate to analytics page\n   - Verify charts render\n   - Apply filters (date range, brand)\n   - Verify data updates\n   - Export CSV and verify download\n\n3. **Rate Limiting**\n   - Make 101 requests to analytics endpoint\n   - Verify 101st returns 429\n   - Verify retry-after header present\n\n4. **i18n**\n   - Switch language to Spanish\n   - Verify analytics labels in Spanish\n   - View public article in Spanish\n   - Verify disclaimer in Spanish\n\n### Performance Testing\n\n**Load Testing (Artillery/k6):**\n- 100 concurrent users viewing public articles\n- 50 concurrent users accessing analytics dashboard\n- Test response times < 2 seconds for dashboard\n- Test page view tracking < 100ms\n\n**Lighthouse:**\n- Public article page score > 90\n- Check accessibility, best practices, SEO\n\n### Security Testing\n\n**OWASP ZAP Scan:**\n- XSS vulnerability testing\n- SQL injection testing (Prisma should prevent)\n- Security headers verification\n- Rate limiting bypass attempts\n\n### Test Coverage Goals\n- Unit tests: 80%+ coverage\n- Integration tests: 70%+ coverage\n- E2E tests: All critical user flows\n- Total coverage: 75%+\n\n## Migration Plan\n\n### Database Migration (1.2.0)\n\n**File:** `migrations/1.2.0/001_add_analytics_indexes.sql`\n```sql\n-- Description: Add indexes for analytics query performance\n-- Version: 1.2.0\n-- Date: 2024-12-XX\n\nCREATE INDEX IF NOT EXISTS idx_pageview_timestamp ON PageView(timestamp);\nCREATE INDEX IF NOT EXISTS idx_pageview_articleid ON PageView(articleId);\nCREATE INDEX IF NOT EXISTS idx_pageview_country ON PageView(country);\nCREATE INDEX IF NOT EXISTS idx_article_status ON Article(status);\nCREATE INDEX IF NOT EXISTS idx_article_publishedat ON Article(publishedAt);\n```\n\n**File:** `migrations/1.2.0/002_add_disclaimer_config.sql`\n```sql\n-- Description: Add system configuration table for disclaimers\n-- Version: 1.2.0\n-- Date: 2024-12-XX\n\nCREATE TABLE IF NOT EXISTS SystemConfig (\n  id TEXT PRIMARY KEY DEFAULT (uuid()),\n  key TEXT UNIQUE NOT NULL,\n  value TEXT NOT NULL,\n  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP\n);\n\n-- Insert default disclaimer configurations\nINSERT INTO SystemConfig (key, value) VALUES\n  ('disclaimer_banner_en', '⚠️ FICTIONAL CONTENT - This article is entirely fictional'),\n  ('disclaimer_banner_es', '⚠️ CONTENIDO FICTICIO - Este artículo es completamente ficticio'),\n  ('disclaimer_footer_en', 'This article is entirely fictional and created for entertainment purposes only...'),\n  ('disclaimer_footer_es', 'Este artículo es completamente ficticio y creado solo con fines de entretenimiento...');\n```\n\n### Version Bump\n```bash\nnpm run version:minor  # 1.1.0 -> 1.2.0\n```\n\n## Deployment Checklist\n\n- [ ] Run all tests (unit, integration, e2e)\n- [ ] Create migration files in `migrations/1.2.0/`\n- [ ] Update version in package.json (npm run version:minor)\n- [ ] Build Docker image\n- [ ] Test Docker container locally\n- [ ] Verify health check endpoint\n- [ ] Configure environment variables (.env)\n- [ ] Set up daily backup cron job\n- [ ] Configure Sentry (optional)\n- [ ] Run OWASP ZAP security scan\n- [ ] Run Lighthouse performance audit\n- [ ] Deploy to production\n- [ ] Verify migrations ran successfully\n- [ ] Smoke test: view public article, check analytics\n- [ ] Monitor logs for errors\n",
  "fileStats": {
    "size": 25406,
    "lines": 823,
    "lastModified": "2025-12-14T13:20:07.159Z"
  },
  "comments": []
}